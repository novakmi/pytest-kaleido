= Requirements for pytest-variant
:toc:
:sectnums:
:experimental:

== User Requirements (UR)

UR-PV-001::
Product variant mechanism
+
The plugin SHALL provide a mechanism to define product variants (e.g., versions, configurations) as test parameters.
+
Tags: system;variant;parameterization
Child: DR-PV-001, DR-PV-002, IR-PV-010

UR-PV-002::
Multiple product support
+
The plugin SHALL allow specifying one or more variant to be tested in a single test session.
+
Tags: system;product;variant
Child: DR-PV-001, DR-PV-002, DR-PV-007, DR-PV-008, IR-PV-010

UR-PV-003::
Pytest parameterization integration
+
The plugin SHOULD integrate with pytest's parameterization features to generate test cases for each variant.
+
Tags: system;pytest;parameterization
Child: DR-PV-001, DR-PV-003

UR-PV-004::
User-friendly variant declaration
+
The plugin SHALL provide a user-friendly way to declare variants in test code or configuration files.
+
Tags: system;usability;configuration
Child: DR-PV-002, DR-PV-004, DR-PV-005, DR-PV-006

UR-PV-005::
Variant selection via CLI
+
The plugin SHOULD allow selection of specific variants via the `--variant` command-line option or pytest configuration.
+
Tags: system;cli;selection
Child: DR-PV-003, DR-PV-007

UR-PV-006::
Variant reporting
+
The plugin SHALL support reporting which variant(s) each test was executed against.
+
Tags: system;reporting
Child: DR-PV-004

UR-PV-007::
Pytest compatibility
+
The plugin SHOULD be compatible with pytest >=7.0.
+
Tags: system;compatibility
Child: IR-PV-004, IR-PV-007

UR-PV-008::
Documentation and examples
+
The plugin SHOULD provide clear documentation and usage examples.
+
Tags: system;documentation
Child: IR-PV-005, IR-PV-006

== Design Requirements (DR)

DR-PV-001::
Fixture/hook for variant injection
+
The plugin SHALL implement a pytest fixture or hook to inject variant parameters into tests.
+
Tags: design;fixture;hook
Child: IR-PV-001, IR-PV-002

DR-PV-002::
Variant definition in config/code
+
The plugin SHALL support variant definitions via pytest configuration files (e.g., `pytest.ini`, `pyproject.toml`) and/or via command line arguments (e.g., `--variant`).
+
Tags: design;configuration;code
Child: IR-PV-002

DR-PV-003::
CLI option for variant selection
+
General format for `--variant`:
  `--variant=[<attribute1>:<attribute2>:...:]<variant>[,[<attribute1>:<attribute2>:...:]<variant>...]`
Attributes in `--variant` are optional. If a `<variant>` is not preceded by any `<attribute>`, it automatically inherits attributes from the previous `<variant>` in the same argument. The first variant in a `--variant` argument may also omit attributes, in which case it is treated as having no attributes. A new `--variant` argument resets the attribute context.
Attributes and variant are separated by colons `:`. Multiple variants in one argument are separated by commas `,`.
Both `:` and `,` can be escaped with a backslash `\` if they are part of an attribute or variant name.
+
A variant value (name) can be specified more than once, with the same or different attributes (even across multiple `--variant` arguments). In this case, all attributes for that variant will be merged into a single variant value with a combined set of attributes.
+
The plugin SHOULD provide a command-line option (e.g., `--variant`) to select specific variants/products for a test run.
This option can be repeated, e.g.:
  `pytest --variant=router --variant=switch`
Multiple variants can also be specified in a single option, separated by commas:
  `pytest --variant=router,switch`
A variant string may begin with one or more attributes, separated by colons `:`, e.g.:
  `pytest --variant=prod1:region1:router,prod2:region2:switch`
If the `:` character is part of the variant name or attribute, it can be escaped with a backslash:
  `pytest --variant=prod1:region1:router\:special`
If the `,` character is part of the variant name, it can be escaped with a backslash:
  `pytest --variant=router\,special`
+
Examples:
  `pytest --variant=a:1.0,1.1 --variant=b:1.0,1.1`
  # creates variants: 1.0 (attributes: a, b), 1.1 (attributes: a, b) (if a variant value is repeated, attributes are merged; each variant will have all attributes)
+
Tags: design;cli
Child: IR-PV-008

DR-PV-004::
Test ID/reporting with variant info
+
The plugin SHALL ensure that test IDs and reports include variant/product information for traceability.
+
Tags: design;reporting
Child: IR-PV-003

DR-PV-005::
Python API for advanced users
+
The plugin SHOULD provide a Python API for advanced users to define and query variants programmatically.
+
Tags: design;api
Child: IR-PV-006

DR-PV-006::
Validation and error messages
+
The plugin SHOULD validate variant definitions and provide clear error messages for misconfiguration.
+
Tags: design;validation
Child: IR-PV-006

DR-PV-007::
Direct CLI variant definition
+
The plugin SHALL provide a mechanism to define variants directly via the `--variant` command-line option, overriding configuration or defaults if specified.
+
Tags: design;cli;override
Child: IR-PV-008

DR-PV-008::
Variant discovery and setup
+
The plugin SHALL provide a command-line option (`--variant-setup`) to specify a general setup string for variant discovery and configuration. The syntax is the same as `--variant` (attributes and variant separated by colons `:`, multiple entries separated by commas `,`; both `:` and `,` can be escaped with a backslash `\`).
Attributes in `--variant-setup` are optional. If a `<variant>` is not preceded by any `<attribute>`, it automatically inherits attributes from the previous `<variant>` in the same argument.
Unlike `--variant`, `--variant-setup` cannot be repeated; only one argument is accepted.
Examples of setup string include a directory path, server location, or other resource identifier.
+
Tags: design;discovery;setup
Child: IR-PV-009

== Implementation Requirements (IR)

IR-PV-001::
Parametrize tests for variants/products
+
The plugin SHALL use pytest's parametrize or metafunc hooks to generate test cases for each variant combination.
+
Tags: impl;parametrize
Child: None

IR-PV-002::
Parse variant definitions at collection
+
The plugin SHALL parse variant definitions from configuration files and/or test code at collection time.
+
Tags: impl;parse;collection
Child: None

IR-PV-003::
Expose variant context to tests
+
The plugin SHOULD add custom markers or test attributes to expose variant context to tests and reporting tools.
+
Tags: impl;marker;context
Child: None

IR-PV-004::
Pytest plugin entry point
+
The plugin SHALL be distributed as a standard pytest plugin (entry point: `pytest11`).
+
Tags: impl;distribution
Child: None

IR-PV-005::
Automated tests for features/errors
+
The plugin SHALL include automated tests for all major features and error conditions.
+
Tags: impl;testing
Child: None

IR-PV-006::
Example usage in docs/tests
+
The plugin SHALL provide example usage in the documentation and/or as sample test files.
+
Tags: impl;documentation
Child: None

IR-PV-007::
CI for pytest compatibility
+
The plugin SHOULD maintain compatibility with future pytest versions via continuous integration.
+
Tags: impl;ci;compatibility
Child: None

IR-PV-008::
Parse/apply CLI variant definitions
+
The plugin SHALL parse and apply variant definitions provided via the `--variant` command-line option, taking precedence over configuration file or code-based definitions.
+
Tags: impl;cli;parse
Child: None

IR-PV-009::
Parse/apply --variant-setup for discovery
+
The plugin SHALL parse and apply the `--variant-setup` option as a path to a product installation directory to influence or override variant/product discovery and parameterization logic.
+
Tags: impl;discovery;directory
Child: None

IR-PV-010::
Abstract base for product plugins
+
The plugin SHALL be designed so it can serve as an abstract base for specific product plugins, enabling reuse and extension of variant-oriented functionality in product-specific pytest plugins.
+
Tags: impl;abstract;reuse
Child: None

.Examples of command-line usage
----
pytest --variant=pro,enterprise
pytest --variant=1.0,1.1,2.0,2.1,3.0
pytest --variant-setup="/opt/products/myproduct/installs/"  # path to product installation directory
# Example: two products, each with different versions
pytest --variant=router:1.0,1.1,special\,edition;switch:2.0,2.1,3.0
# Example: variant string with multiple attributes
pytest --variant=prod1:region1:router,prod2:region2:switch
# Escaping ':' and ',' in variant names and attributes
pytest --variant=prod1:region1:router\:special,prod2:region2:switch\,special
# Multiple --variant arguments
pytest --variant=router:1.0 --variant=router:1.1 --variant=switch:2.0 --variant=switch:2.1
# Mixing single and multiple variants in one argument
pytest --variant=router:1.0,1.1 --variant=switch:2.0,2.1,3.0
# Escaping in repeated arguments
pytest --variant=router\,special --variant=switch\:special
----
