= pytest-kaleido
:experimental:
:icons: font
:toc: left
:source-highlighter: coderay

ifdef::env-github[]
:caution-caption: :fire:
:important-caption: :exclamation:
:note-caption: :information_source:
:tip-caption: :bulb:
:warning-caption: :warning:
endif::[]

:Author:    Michal Nov√°k
:email:     it.novakmi@gmail.com
:URL:       https://github.com/novakmi/pytest-kaleido
:Date:      2025-07-29
:Revision:  0.1.0

== Introduction

The `pytest-kaleido` plugin abstracts and simplifies testing across different variants or versions of your product or system. Transforms your test suite into a kaleidoscope of coverage, allowing you to run tests across multiple dimensions like version, platform, and feature flags from a single codebase.

https://docs.pytest.org/[Pytest] is a well-known Python test framework with rich features and flexibility.

== Installation

=== `pip3` installation

You can install the `pytest-kaleido` plugin with `pip3`.

.Install from https://pypi.org/ (not yet available)
----
# pip3 install pytest-kaleido
----

.Clone repository and install from the directory
----
git clone https://github.com/novakmi/pytest-kaleido.git
cd pytest-kaleido
pip3 install .
----
NOTE: Or `pip3 install pytest-kaleido/` from the parent directory.

.Uninstall plugin
----
pip3 uninstall pytest-kaleido
----

=== `PYTHONPATH` installation

Set PYTHONPATH to the `pytest-kaleido/src` directory (run from the root of the repository):
[source, shell]
----
export PYTHONPATH=./src:$PYTHONPATH
----

Add into your `conftest.py`:
[source, python]
----
pytest_plugins = ["pytest_kaleido"]
----

or add into `pytest.ini`:
[source,ini]
----
[pytest]
addopts = -p pytest_kaleido
----

=== Verify installation

[source, shell]
----
pytest --trace-config
----

== Parameters

See the documentation or run `pytest --help` for all available options.

== Quick start

. Create a test file, e.g. `test_example.py`:
[source,python]
----
def test_variant(variant):
    print(f"Testing variant: {variant.attributes} / {variant.variant}")
    assert variant.variant is not None
----

. Run pytest with variants:
[source, shell]
----
pytest --kaleido-variant=router:1.0,router:1.1,switch:2.0
----

== User guide

=== Variant syntax

Variants are specified using the `--kaleido-variant` option. Each variant can have zero or more attributes and a variant name, separated by colons (`:`). Multiple variants can be specified in a single `--kaleido-variant` argument, separated by commas (`,`). Both `:` and `,` can be escaped with a backslash (`\`) if they are part of an attribute or variant name.

.Syntax
----
--kaleido-variant=[<attribute1>:<attribute2>:...:]<variant>[,[<attribute1>:<attribute2>:...:]<variant>...]
----

You can repeat the `--kaleido-variant` option to specify more variants. If a variant in a comma-separated list omits attributes, it inherits the attributes from the previous variant in the same argument. The first variant in a `--kaleido-variant` argument may also omit attributes, in which case it is treated as having no attributes. A new `--kaleido-variant` argument resets the attribute context.

.Examples
----
--kaleido-variant=router:1.0,1.1,switch:2.0
// <1> <2> <3>
--kaleido-variant=1.0,1.1,special:2.0
// <4> <5> <6>
--kaleido-variant=router:special:1.0,1.1,1\,2,1\:0,1:0
// <7> <8> <9> <10> <11>
--kaleido-variant=a:1.0,1.1 --kaleido-variant=b:1.0,1.1
// <12> <13> <14> <15>
--kaleido-variant=win:C\:\\Program Files\\App,linux:/opt/app,win:C\:\\App,linux:/opt/app\,special
// <16> <17> <18> <19>
----
<1> router:1.0      (attributes: router, variant: 1.0)
<2> router:1.1      (attributes: router, variant: 1.1)
<3> switch:2.0      (attributes: switch, variant: 2.0)
<4> 1.0             (no attributes, variant: 1.0)
<5> 1.1             (no attributes, variant: 1.1)
<6> special:2.0     (attributes: special, variant: 2.0)
<7> router:special:1.0   (attributes: router, special, variant: 1.0)
<8> router:special:1.1   (attributes: router, special, variant: 1.1)
<9> router:special:1,2   (attributes: router, special, variant: 1,2; escaping: '1\,2' means '1,2')
<10> router:special:1:0  (attributes: router, special, variant: 1:0; escaping: '1\:0' means '1:0')
<11> router:special:1:0  (attributes: router, special, variant: 1:0; resets attributes to ['1'], variant: 0)
<12> a:1.0          (attributes: a, variant: 1.0)
<13> a:1.1          (attributes: a, variant: 1.1)
<14> b:1.0          (attributes: b, variant: 1.0)
<15> b:1.1          (attributes: b, variant: 1.1)
<16> win:C:\Program Files\App (attributes: win, variant: C:\Program Files\App; escaping: 'C\:\\Program Files\\App')
<17> linux:/opt/app (attributes: linux, variant: /opt/app)
<18> win:C:\App     (attributes: win, variant: C:\App; escaping: 'C\:\\App')
<19> linux:/opt/app,special (attributes: linux, variant: /opt/app,special; escaping: '/opt/app\,special')

=== Variant setup syntax

The `--kaleido-variant-setup` option is used to provide a general setup/discovery string (e.g., directory, server location). It uses the same syntax as `--kaleido-variant`, but cannot be repeated.

.Example
----
--kaleido-variant-setup=win:C\:\\Program Files\\App,linux:/opt/app
----

=== Source code examples

.Basic test using the variant fixture
[source,python]
----
def test_variant(variant):
    print(f"Testing variant: {variant.attributes} / {variant.variant}")
    assert variant.variant is not None
----

.Using variant_attributes and variant_variants fixtures
[source,python]
----
def test_attributes_and_variants(variant_attributes, variant_variants):
    print("All attributes:", variant_attributes)
    print("Router variants:", variant_variants('router'))
    print("Special variants:", variant_variants('special'))
    assert 'router' in variant_attributes
    assert set(variant_variants('router')) == {'1.0', '1.1'}
----

.Using variant-setup in a test
[source,python]
----
def test_variant_setup(variant_setup):
    print(f"Variant setup string: {variant_setup}")
    assert variant_setup is not None
----

.See the `tests/` directory for more usage examples, including advanced parametrization and edge cases.

== Plugin tests

Run full `tox` tests
[source,bash]
----
tox
----

Run full `tox`  `flake8`  tests
[source,bash]
----
tox -e flake8
----

Run  `pytest` tests
[source,bash]
----
pytest -o log_cli=true -o log_cli_level=DEBUG tests/
----

== Planned features

* Improve code documentation
* Add more usage examples

== Links

* https://pytest.org[pytest]

=== Similar projects

TODO
